{% extends "base.html" %}

{% block title %}Webhooks Management{% endblock %}

{% block extra_css %}
<style>
.webhook-card {
    border-left: 4px solid #28a745;
}

.webhook-status {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    display: inline-block;
    margin-right: 0.5rem;
}

.webhook-status.active {
    background-color: #28a745;
}

.webhook-status.inactive {
    background-color: #dc3545;
}

.webhook-status.pending {
    background-color: #ffc107;
}

.event-badge {
    font-size: 0.75rem;
}

.webhook-url {
    font-family: 'Courier New', monospace;
    word-break: break-all;
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2><i class="fas fa-webhook me-2"></i>Webhooks Management</h2>
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item"><a href="{{ url_for('extensions.index') }}">Extensions</a></li>
                            <li class="breadcrumb-item active">Webhooks</li>
                        </ol>
                    </nav>
                </div>
                <button class="btn btn-success" onclick="showCreateModal()">
                    <i class="fas fa-plus me-1"></i>Add Webhook
                </button>
            </div>

            <!-- Building Selection -->
            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-building me-2"></i>Building Selection</h5>
                        </div>
                        <div class="card-body">
                            <select class="form-select" id="buildingSelect" onchange="loadWebhooks()">
                                <option value="">Select a building...</option>
                                {% for building in buildings %}
                                <option value="{{ building.id }}">{{ building.name }} - {{ building.address.street }} {{ building.address.number }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>Webhook Information</h5>
                        </div>
                        <div class="card-body">
                            <p class="mb-1"><strong>Format:</strong> JSON POST requests</p>
                            <p class="mb-1"><strong>Timeout:</strong> 30 seconds</p>
                            <p class="mb-0"><strong>Retries:</strong> 3 attempts with exponential backoff</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Webhooks List -->
            <div id="webhooksContainer" style="display: none;">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h4><i class="fas fa-list me-2"></i>Active Webhooks</h4>
                    <span class="badge bg-secondary" id="webhookCount">0 webhooks</span>
                </div>

                <div class="row" id="webhooksList">
                    <!-- Webhooks will be loaded here -->
                </div>
                
                <div id="noWebhooks" class="text-center py-5" style="display: none;">
                    <i class="fas fa-webhook fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">No webhooks configured</h5>
                    <p class="text-muted">Set up webhooks to receive real-time notifications about building events.</p>
                    <button class="btn btn-success" onclick="showCreateModal()">
                        <i class="fas fa-plus me-1"></i>Add First Webhook
                    </button>
                </div>
            </div>

            <!-- Recent Deliveries -->
            <div class="row mt-4" id="recentDeliveries" style="display: none;">
                <div class="col-12">
                    <h4><i class="fas fa-history me-2"></i>Recent Webhook Deliveries</h4>
                    <div class="card">
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Webhook</th>
                                            <th>Event</th>
                                            <th>Status</th>
                                            <th>Response</th>
                                            <th>Delivered</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="deliveriesTable">
                                        <tr>
                                            <td colspan="6" class="text-center text-muted">No recent deliveries</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Create Webhook Modal -->
<div class="modal fade" id="createWebhookModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Webhook</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="createWebhookForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="webhookName" class="form-label">Webhook Name</label>
                                <input type="text" class="form-control" id="webhookName" placeholder="e.g., Slack Notifications" required>
                                <div class="form-text">A descriptive name for this webhook</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="webhookBuilding" class="form-label">Building</label>
                                <select class="form-select" id="webhookBuilding" required>
                                    <option value="">Select building...</option>
                                    {% for building in buildings %}
                                    <option value="{{ building.id }}">{{ building.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="webhookUrl" class="form-label">Webhook URL</label>
                        <input type="url" class="form-control" id="webhookUrl" placeholder="https://hooks.slack.com/services/..." required>
                        <div class="form-text">The endpoint that will receive webhook notifications</div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Events to Subscribe</label>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" value="resident.created" id="eventResidentCreated">
                                    <label class="form-check-label" for="eventResidentCreated">
                                        New Resident Added
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" value="expense.created" id="eventExpenseCreated">
                                    <label class="form-check-label" for="eventExpenseCreated">
                                        New Expense Created
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" value="payment.received" id="eventPaymentReceived">
                                    <label class="form-check-label" for="eventPaymentReceived">
                                        Payment Received
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" value="announcement.published" id="eventAnnouncementPublished">
                                    <label class="form-check-label" for="eventAnnouncementPublished">
                                        Announcement Published
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" value="invoice.created" id="eventInvoiceCreated">
                                    <label class="form-check-label" for="eventInvoiceCreated">
                                        Invoice Generated
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" value="invoice.overdue" id="eventInvoiceOverdue">
                                    <label class="form-check-label" for="eventInvoiceOverdue">
                                        Invoice Overdue
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" value="meeting.scheduled" id="eventMeetingScheduled">
                                    <label class="form-check-label" for="eventMeetingScheduled">
                                        Meeting Scheduled
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" value="emergency.alert" id="eventEmergencyAlert">
                                    <label class="form-check-label" for="eventEmergencyAlert">
                                        Emergency Alert
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="webhookSecret" class="form-label">Secret (Optional)</label>
                                <input type="text" class="form-control" id="webhookSecret" placeholder="Enter webhook secret">
                                <div class="form-text">Used to verify webhook authenticity</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="webhookFormat" class="form-label">Payload Format</label>
                                <select class="form-select" id="webhookFormat">
                                    <option value="standard">Standard JSON</option>
                                    <option value="slack">Slack Format</option>
                                    <option value="discord">Discord Format</option>
                                    <option value="custom">Custom Template</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3" id="customTemplateDiv" style="display: none;">
                        <label for="customTemplate" class="form-label">Custom Template</label>
                        <textarea class="form-control" id="customTemplate" rows="4" placeholder="Custom JSON template using {{variables}}"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-outline-primary me-2" onclick="testWebhookConnection()">
                    <i class="fas fa-flask me-1"></i>Test Connection
                </button>
                <button type="button" class="btn btn-success" onclick="createWebhook()">
                    <i class="fas fa-plus me-1"></i>Create Webhook
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Test Webhook Modal -->
<div class="modal fade" id="testWebhookModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Test Webhook</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Send a test event to verify the webhook is working correctly.</p>
                <div class="mb-3">
                    <label for="testEventType" class="form-label">Test Event Type</label>
                    <select class="form-select" id="testEventType">
                        <option value="test">Test Event</option>
                        <option value="resident.created">New Resident</option>
                        <option value="payment.received">Payment Received</option>
                        <option value="announcement.published">Announcement Published</option>
                    </select>
                </div>
                <div id="testResult" class="alert" style="display: none;"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="sendTestWebhook()">
                    <i class="fas fa-paper-plane me-1"></i>Send Test
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let selectedBuildingId = null;
let testWebhookId = null;

function showCreateModal() {
    const buildingSelect = document.getElementById('buildingSelect');
    if (buildingSelect.value) {
        document.getElementById('webhookBuilding').value = buildingSelect.value;
    }
    new bootstrap.Modal(document.getElementById('createWebhookModal')).show();
}

function loadWebhooks() {
    const buildingId = document.getElementById('buildingSelect').value;
    selectedBuildingId = buildingId;
    
    if (!buildingId) {
        document.getElementById('webhooksContainer').style.display = 'none';
        document.getElementById('recentDeliveries').style.display = 'none';
        return;
    }

    // Show containers
    document.getElementById('webhooksContainer').style.display = 'block';
    document.getElementById('recentDeliveries').style.display = 'block';

    // Load webhooks (placeholder - implement actual loading)
    loadSampleWebhooks();
}

function loadSampleWebhooks() {
    // Sample data - replace with actual API call
    const sampleWebhooks = [
        {
            id: 1,
            name: 'Slack Notifications',
            url: 'https://hooks.slack.com/services/T00000000/B00000000/XXXXXXXXXXXXXXXXXXXXXXXX',
            events: ['resident.created', 'payment.received', 'announcement.published'],
            status: 'active',
            created_at: '2024-01-15',
            last_delivery: '2024-01-20 14:30',
            success_rate: 98.5
        },
        {
            id: 2,
            name: 'Discord Alerts',
            url: 'https://discord.com/api/webhooks/123456789/abcdefghijklmnop',
            events: ['invoice.overdue', 'emergency.alert'],
            status: 'active',
            created_at: '2024-01-10',
            last_delivery: '2024-01-19 09:15',
            success_rate: 100.0
        }
    ];

    displayWebhooks(sampleWebhooks);
}

function displayWebhooks(webhooks) {
    const container = document.getElementById('webhooksList');
    const countElement = document.getElementById('webhookCount');
    const noWebhooksElement = document.getElementById('noWebhooks');

    if (webhooks.length === 0) {
        container.innerHTML = '';
        noWebhooksElement.style.display = 'block';
        countElement.textContent = '0 webhooks';
        return;
    }

    noWebhooksElement.style.display = 'none';
    countElement.textContent = webhooks.length + ' webhook' + (webhooks.length !== 1 ? 's' : '');

    container.innerHTML = webhooks.map(webhook => `
        <div class="col-md-6 mb-3">
            <div class="card webhook-card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <div class="d-flex align-items-center">
                        <span class="webhook-status ${webhook.status}"></span>
                        <h6 class="mb-0">${webhook.name}</h6>
                    </div>
                    <div class="dropdown">
                        <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                            Actions
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="#" onclick="testWebhook(${webhook.id})">
                                <i class="fas fa-flask me-1"></i>Test
                            </a></li>
                            <li><a class="dropdown-item" href="#" onclick="editWebhook(${webhook.id})">
                                <i class="fas fa-edit me-1"></i>Edit
                            </a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item text-danger" href="#" onclick="deleteWebhook(${webhook.id})">
                                <i class="fas fa-trash me-1"></i>Delete
                            </a></li>
                        </ul>
                    </div>
                </div>
                <div class="card-body">
                    <div class="mb-2">
                        <small class="text-muted">URL:</small>
                        <div class="webhook-url text-truncate">${webhook.url}</div>
                    </div>
                    
                    <div class="mb-2">
                        <small class="text-muted">Events:</small><br>
                        ${webhook.events.map(event => `<span class="badge bg-primary event-badge me-1">${event}</span>`).join('')}
                    </div>
                    
                    <div class="row text-center mt-3">
                        <div class="col-4">
                            <small class="text-muted">Success Rate</small><br>
                            <strong class="text-success">${webhook.success_rate}%</strong>
                        </div>
                        <div class="col-4">
                            <small class="text-muted">Created</small><br>
                            <strong>${webhook.created_at}</strong>
                        </div>
                        <div class="col-4">
                            <small class="text-muted">Last Delivery</small><br>
                            <strong>${webhook.last_delivery}</strong>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `).join('');
}

function createWebhook() {
    const form = document.getElementById('createWebhookForm');
    
    const name = document.getElementById('webhookName').value;
    const url = document.getElementById('webhookUrl').value;
    const buildingId = document.getElementById('webhookBuilding').value;
    
    if (!name || !url || !buildingId) {
        showAlert('Please fill in all required fields', 'warning');
        return;
    }

    // Get selected events
    const events = [];
    document.querySelectorAll('#createWebhookForm input[type="checkbox"]:checked').forEach(checkbox => {
        events.push(checkbox.value);
    });

    if (events.length === 0) {
        showAlert('Please select at least one event to subscribe to', 'warning');
        return;
    }

    const webhookData = {
        name: name,
        url: url,
        building_id: parseInt(buildingId),
        events: events,
        secret: document.getElementById('webhookSecret').value,
        format: document.getElementById('webhookFormat').value,
        custom_template: document.getElementById('customTemplate').value
    };

    // Simulate webhook creation (replace with actual API call)
    setTimeout(() => {
        bootstrap.Modal.getInstance(document.getElementById('createWebhookModal')).hide();
        showAlert('Webhook created successfully!', 'success');
        loadWebhooks(); // Reload the list
    }, 500);
}

function testWebhookConnection() {
    const url = document.getElementById('webhookUrl').value;
    if (!url) {
        showAlert('Please enter a webhook URL first', 'warning');
        return;
    }

    fetch('/extensions/api/test-webhook', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            url: url,
            test_data: {
                event: 'webhook.test',
                message: 'This is a test webhook from WebPortal',
                timestamp: new Date().toISOString()
            }
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('Webhook test successful! Status: ' + data.status_code, 'success');
        } else {
            showAlert('Webhook test failed: ' + data.error, 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('Error testing webhook', 'danger');
    });
}

function testWebhook(webhookId) {
    testWebhookId = webhookId;
    new bootstrap.Modal(document.getElementById('testWebhookModal')).show();
}

function sendTestWebhook() {
    const eventType = document.getElementById('testEventType').value;
    const resultDiv = document.getElementById('testResult');
    
    // Simulate sending test webhook
    resultDiv.className = 'alert alert-info';
    resultDiv.style.display = 'block';
    resultDiv.textContent = 'Sending test webhook...';
    
    setTimeout(() => {
        resultDiv.className = 'alert alert-success';
        resultDiv.innerHTML = '<i class="fas fa-check me-1"></i>Test webhook sent successfully! Status: 200 OK';
    }, 1000);
}

function editWebhook(webhookId) {
    showAlert('Webhook editing not implemented yet', 'info');
}

function deleteWebhook(webhookId) {
    if (confirm('Are you sure you want to delete this webhook? This action cannot be undone.')) {
        showAlert('Webhook deletion not implemented yet', 'info');
    }
}

// Show/hide custom template field
document.getElementById('webhookFormat').addEventListener('change', function() {
    const customDiv = document.getElementById('customTemplateDiv');
    customDiv.style.display = this.value === 'custom' ? 'block' : 'none';
});

function showAlert(message, type = 'info') {
    const alert = document.createElement('div');
    alert.className = `alert alert-${type} alert-dismissible fade show`;
    alert.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    const container = document.querySelector('.container-fluid');
    container.insertBefore(alert, container.firstChild);
    
    setTimeout(() => {
        alert.remove();
    }, 5000);
}
</script>
{% endblock %}