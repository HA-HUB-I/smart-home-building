{% extends "base.html" %}

{% block title %}Expense Details - {{ expense.period.strftime('%Y-%m') }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{{ url_for('finance.index') }}">Finance</a></li>
                    <li class="breadcrumb-item"><a href="{{ url_for('finance.expenses') }}">Expenses</a></li>
                    <li class="breadcrumb-item active">{{ expense.period.strftime('%Y-%m') }}</li>
                </ol>
            </nav>
            <h2><i class="fas fa-receipt me-2"></i>Expense Details</h2>
            <p class="text-muted">{{ expense.category.name }} - {{ expense.building.name }}</p>
        </div>
        <div class="btn-group">
            {% if current_user.is_superuser or current_user.has_role('manager', expense.building) %}
            <a href="{{ url_for('finance.edit_expense', expense_id=expense.id) }}" class="btn btn-warning">
                <i class="fas fa-edit me-1"></i>Edit
            </a>
            {% endif %}
            {% if not expense.allocations %}
            <button class="btn btn-success" onclick="generateAllocations({{ expense.id }})">
                <i class="fas fa-calculator me-1"></i>Generate Allocations
            </button>
            {% endif %}
            <div class="btn-group">
                <button class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
                    <i class="fas fa-download me-1"></i>Export
                </button>
                <ul class="dropdown-menu">
                    <li><a class="dropdown-item" href="#"><i class="fas fa-file-pdf me-2"></i>PDF</a></li>
                    <li><a class="dropdown-item" href="#"><i class="fas fa-file-excel me-2"></i>Excel</a></li>
                </ul>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Expense Information -->
        <div class="col-lg-4 mb-4">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-info-circle me-2"></i>Expense Information</h5>
                </div>
                <div class="card-body">
                    <table class="table table-borderless">
                        <tr>
                            <td><strong>Period:</strong></td>
                            <td>{{ expense.period.strftime('%B %Y') }}</td>
                        </tr>
                        <tr>
                            <td><strong>Building:</strong></td>
                            <td>
                                <a href="{{ url_for('finance.building_finance', building_id=expense.building_id) }}">
                                    {{ expense.building.name }}
                                </a>
                            </td>
                        </tr>
                        <tr>
                            <td><strong>Category:</strong></td>
                            <td>
                                <span class="badge bg-light text-dark">{{ expense.category.name }}</span>
                            </td>
                        </tr>
                        <tr>
                            <td><strong>Code:</strong></td>
                            <td><code>{{ expense.category.code }}</code></td>
                        </tr>
                        <tr>
                            <td><strong>Total Amount:</strong></td>
                            <td><h5 class="text-primary mb-0">{{ "%.2f"|format(expense.amount_total) }} лв.</h5></td>
                        </tr>
                        <tr>
                            <td><strong>Allocation Method:</strong></td>
                            <td>
                                <span class="badge bg-info">{{ expense.category.allocation_method.value|title }}</span>
                            </td>
                        </tr>
                        <tr>
                            <td><strong>Status:</strong></td>
                            <td>
                                {% if expense.allocations %}
                                    <span class="badge bg-success">
                                        <i class="fas fa-check me-1"></i>Allocated
                                    </span>
                                {% else %}
                                    <span class="badge bg-warning">
                                        <i class="fas fa-clock me-1"></i>Pending Allocation
                                    </span>
                                {% endif %}
                            </td>
                        </tr>
                        <tr>
                            <td><strong>Created:</strong></td>
                            <td>
                                {{ expense.created_at.strftime('%d.%m.%Y %H:%M') }}<br>
                                <small class="text-muted">by {{ expense.created_by.full_name if expense.created_by else 'System' }}</small>
                            </td>
                        </tr>
                    </table>

                    {% if expense.notes %}
                    <div class="mt-3">
                        <strong>Description:</strong>
                        <div class="mt-2 p-3 bg-light rounded">
                            {{ expense.notes }}
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Allocation Summary -->
            {% if expense.allocations %}
            <div class="card mt-4">
                <div class="card-header">
                    <h5><i class="fas fa-chart-pie me-2"></i>Allocation Summary</h5>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-6">
                            <h6 class="text-primary">Total Units</h6>
                            <h4>{{ expense.allocations|length }}</h4>
                        </div>
                        <div class="col-6">
                            <h6 class="text-success">Allocated</h6>
                            <h4>{{ "%.2f"|format(expense.allocations|sum(attribute='amount')) }} лв.</h4>
                        </div>
                    </div>

                    {% set diff = expense.amount_total - (expense.allocations|sum(attribute='amount')) %}
                    {% if diff != 0 %}
                    <div class="mt-3 p-2 {% if diff > 0 %}bg-warning{% else %}bg-danger{% endif %} bg-opacity-10 rounded">
                        <small class="{% if diff > 0 %}text-warning{% else %}text-danger{% endif %}">
                            <i class="fas fa-exclamation-triangle me-1"></i>
                            Difference: {{ "%.2f"|format(diff) }} лв.
                        </small>
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Allocations Details -->
        <div class="col-lg-8 mb-4">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5><i class="fas fa-list me-2"></i>Unit Allocations</h5>
                    {% if expense.allocations %}
                    <span class="badge bg-success">{{ expense.allocations|length }} units</span>
                    {% endif %}
                </div>
                <div class="card-body">
                    {% if expense.allocations %}
                        <div class="table-responsive">
                            <table class="table table-striped table-sm">
                                <thead>
                                    <tr>
                                        <th>Unit</th>
                                        <th>Contact</th>
                                        <th class="text-end">Area (m²)</th>
                                        <th class="text-end">Shares</th>
                                        <th class="text-end">Amount</th>
                                        <th class="text-end">%</th>
                                        <th class="text-center">Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for allocation in expense.allocations|sort(attribute='unit.full_number') %}
                                    <tr>
                                        <td>
                                            <a href="{{ url_for('buildings.view_unit', building_id=expense.building_id, unit_id=allocation.unit_id) }}" 
                                               class="text-decoration-none fw-bold">
                                                {{ allocation.unit.full_number }}
                                            </a>
                                        </td>
                                        <td>
                                            {% set primary = allocation.unit.memberships|selectattr('is_primary')|first %}
                                            {% if primary %}
                                                {{ primary.user.full_name }}
                                                {% if primary.user.phone %}
                                                <br><small class="text-muted">{{ primary.user.phone }}</small>
                                                {% endif %}
                                            {% else %}
                                                <span class="text-muted">No contact</span>
                                            {% endif %}
                                        </td>
                                        <td class="text-end">
                                            {% if allocation.unit.area_m2 %}
                                                {{ "%.1f"|format(allocation.unit.area_m2) }}
                                            {% else %}
                                                <span class="text-muted">-</span>
                                            {% endif %}
                                        </td>
                                        <td class="text-end">
                                            {% if allocation.unit.shares %}
                                                {{ "%.6f"|format(allocation.unit.shares) }}
                                            {% else %}
                                                <span class="text-muted">-</span>
                                            {% endif %}
                                        </td>
                                        <td class="text-end">
                                            <strong>{{ "%.2f"|format(allocation.amount) }} лв.</strong>
                                        </td>
                                        <td class="text-end">
                                            <small class="text-muted">
                                                {{ "%.2f"|format((allocation.amount / expense.amount_total) * 100) }}%
                                            </small>
                                        </td>
                                        <td class="text-center">
                                            {% if allocation.invoiced %}
                                                <span class="badge bg-success">
                                                    <i class="fas fa-check me-1"></i>Invoiced
                                                </span>
                                            {% else %}
                                                <span class="badge bg-warning">
                                                    <i class="fas fa-clock me-1"></i>Pending
                                                </span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                                <tfoot>
                                    <tr class="table-active">
                                        <th colspan="4" class="text-end">Total:</th>
                                        <th class="text-end">{{ "%.2f"|format(expense.allocations|sum(attribute='amount')) }} лв.</th>
                                        <th class="text-end">100.00%</th>
                                        <th></th>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>

                        <!-- Action Buttons -->
                        <div class="mt-3 d-flex gap-2">
                            {% if not expense.allocations|selectattr('invoiced')|list %}
                            <button class="btn btn-primary" onclick="generateInvoices({{ expense.id }})">
                                <i class="fas fa-file-invoice me-1"></i>Generate Invoices
                            </button>
                            {% endif %}
                            <button class="btn btn-outline-secondary" onclick="exportAllocations({{ expense.id }})">
                                <i class="fas fa-download me-1"></i>Export Allocations
                            </button>
                        </div>

                    {% else %}
                        <!-- No Allocations -->
                        <div class="text-center py-5">
                            <i class="fas fa-calculator fa-3x text-muted mb-3"></i>
                            <h4>No Allocations Generated</h4>
                            <p class="text-muted">
                                This expense has not been allocated to units yet.<br>
                                Click the button below to generate allocations based on the <strong>{{ expense.category.allocation_method.value|title }}</strong> method.
                            </p>
                            <button class="btn btn-success btn-lg" onclick="generateAllocations({{ expense.id }})">
                                <i class="fas fa-calculator me-2"></i>Generate Allocations
                            </button>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Generate allocations
function generateAllocations(expenseId) {
    if (!confirm('Generate allocations for this expense? This will distribute the total amount across all units based on the allocation method.')) {
        return;
    }
    
    const btn = event.target;
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Generating...';
    
    fetch(`/finance/api/expenses/${expenseId}/allocate`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('meta[name=csrf-token]').content
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            window.location.reload();
        } else {
            alert('Error: ' + data.message);
            btn.disabled = false;
            btn.innerHTML = originalText;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Network error occurred');
        btn.disabled = false;
        btn.innerHTML = originalText;
    });
}

// Generate invoices from allocations
function generateInvoices(expenseId) {
    if (!confirm('Generate invoices for all allocated amounts? This will create individual invoices for each unit.')) {
        return;
    }
    
    const btn = event.target;
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Generating...';
    
    fetch(`/finance/api/expenses/${expenseId}/invoices`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('meta[name=csrf-token]').content
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`Generated ${data.count} invoices successfully`);
            window.location.reload();
        } else {
            alert('Error: ' + data.message);
            btn.disabled = false;
            btn.innerHTML = originalText;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Network error occurred');
        btn.disabled = false;
        btn.innerHTML = originalText;
    });
}

// Export allocations
function exportAllocations(expenseId) {
    window.open(`/finance/api/expenses/${expenseId}/export`, '_blank');
}
</script>
{% endblock %}