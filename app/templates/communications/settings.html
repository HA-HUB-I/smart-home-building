{% extends "base.html" %}

{% block title %}Notification Settings{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2><i class="fas fa-cog me-2"></i>Notification Settings</h2>
            <p class="text-muted">Manage your notification preferences and delivery methods</p>
        </div>
        <div class="btn-group" role="group">
            <a href="{{ url_for('communications.notifications') }}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-1"></i>Back to Notifications
            </a>
            <button type="button" class="btn btn-success" onclick="testNotifications()">
                <i class="fas fa-bell me-1"></i>Test Notifications
            </button>
        </div>
    </div>

    <form method="POST" id="settingsForm">
        
        <div class="row">
            <!-- Notification Types -->
            <div class="col-lg-8">
                <div class="card mb-4">
                    <div class="card-header">
                        <h5><i class="fas fa-list me-2"></i>Notification Types</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-borderless">
                                <thead>
                                    <tr>
                                        <th>Type</th>
                                        <th class="text-center">Email</th>
                                        <th class="text-center">Push</th>
                                        <th class="text-center">SMS</th>
                                        <th class="text-center">In-App</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Announcements -->
                                    <tr>
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <i class="fas fa-bullhorn text-primary me-2"></i>
                                                <div>
                                                    <strong>Announcements</strong>
                                                    <br><small class="text-muted">New building announcements</small>
                                                </div>
                                            </div>
                                        </td>
                                        <td class="text-center">
                                            <div class="form-check">
                                                <input type="checkbox" name="notifications[announcements][email]" 
                                                       class="form-check-input"
                                                       {% if settings.notifications and settings.notifications.announcements and settings.notifications.announcements.email %}checked{% endif %}>
                                            </div>
                                        </td>
                                        <td class="text-center">
                                            <div class="form-check">
                                                <input type="checkbox" name="notifications[announcements][push]" 
                                                       class="form-check-input"
                                                       {% if settings.notifications and settings.notifications.announcements and settings.notifications.announcements.push %}checked{% endif %}>
                                            </div>
                                        </td>
                                        <td class="text-center">
                                            <div class="form-check">
                                                <input type="checkbox" name="notifications[announcements][sms]" 
                                                       class="form-check-input"
                                                       {% if settings.notifications and settings.notifications.announcements and settings.notifications.announcements.sms %}checked{% endif %}>
                                            </div>
                                        </td>
                                        <td class="text-center">
                                            <div class="form-check">
                                                <input type="checkbox" name="notifications[announcements][app]" 
                                                       class="form-check-input"
                                                       {% if settings.notifications and settings.notifications.announcements and settings.notifications.announcements.app %}checked{% endif %}>
                                            </div>
                                        </td>
                                    </tr>

                                    <!-- Urgent Announcements -->
                                    <tr class="bg-light">
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <i class="fas fa-exclamation-triangle text-danger me-2"></i>
                                                <div>
                                                    <strong>Urgent Announcements</strong>
                                                    <br><small class="text-muted">High priority announcements</small>
                                                </div>
                                            </div>
                                        </td>
                                        <td class="text-center">
                                            <div class="form-check">
                                                <input type="checkbox" name="notifications[urgent][email]" 
                                                       class="form-check-input"
                                                       {% if settings.notifications and settings.notifications.urgent and settings.notifications.urgent.email %}checked{% endif %}>
                                            </div>
                                        </td>
                                        <td class="text-center">
                                            <div class="form-check">
                                                <input type="checkbox" name="notifications[urgent][push]" 
                                                       class="form-check-input"
                                                       {% if settings.notifications and settings.notifications.urgent and settings.notifications.urgent.push %}checked{% endif %}>
                                            </div>
                                        </td>
                                        <td class="text-center">
                                            <div class="form-check">
                                                <input type="checkbox" name="notifications[urgent][sms]" 
                                                       class="form-check-input"
                                                       {% if settings.notifications and settings.notifications.urgent and settings.notifications.urgent.sms %}checked{% endif %}>
                                            </div>
                                        </td>
                                        <td class="text-center">
                                            <div class="form-check">
                                                <input type="checkbox" name="notifications[urgent][app]" 
                                                       class="form-check-input" checked disabled>
                                            </div>
                                        </td>
                                    </tr>

                                    <!-- Payment Reminders -->
                                    <tr>
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <i class="fas fa-credit-card text-warning me-2"></i>
                                                <div>
                                                    <strong>Payment Reminders</strong>
                                                    <br><small class="text-muted">Invoice and payment due dates</small>
                                                </div>
                                            </div>
                                        </td>
                                        <td class="text-center">
                                            <div class="form-check">
                                                <input type="checkbox" name="notifications[payments][email]" 
                                                       class="form-check-input"
                                                       {% if settings.notifications and settings.notifications.payments and settings.notifications.payments.email %}checked{% endif %}>
                                            </div>
                                        </td>
                                        <td class="text-center">
                                            <div class="form-check">
                                                <input type="checkbox" name="notifications[payments][push]" 
                                                       class="form-check-input"
                                                       {% if settings.notifications and settings.notifications.payments and settings.notifications.payments.push %}checked{% endif %}>
                                            </div>
                                        </td>
                                        <td class="text-center">
                                            <div class="form-check">
                                                <input type="checkbox" name="notifications[payments][sms]" 
                                                       class="form-check-input"
                                                       {% if settings.notifications and settings.notifications.payments and settings.notifications.payments.sms %}checked{% endif %}>
                                            </div>
                                        </td>
                                        <td class="text-center">
                                            <div class="form-check">
                                                <input type="checkbox" name="notifications[payments][app]" 
                                                       class="form-check-input"
                                                       {% if settings.notifications and settings.notifications.payments and settings.notifications.payments.app %}checked{% endif %}>
                                            </div>
                                        </td>
                                    </tr>

                                    <!-- Building Updates -->
                                    <tr class="bg-light">
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <i class="fas fa-building text-info me-2"></i>
                                                <div>
                                                    <strong>Building Updates</strong>
                                                    <br><small class="text-muted">Maintenance, repairs, and updates</small>
                                                </div>
                                            </div>
                                        </td>
                                        <td class="text-center">
                                            <div class="form-check">
                                                <input type="checkbox" name="notifications[building][email]" 
                                                       class="form-check-input"
                                                       {% if settings.notifications and settings.notifications.building and settings.notifications.building.email %}checked{% endif %}>
                                            </div>
                                        </td>
                                        <td class="text-center">
                                            <div class="form-check">
                                                <input type="checkbox" name="notifications[building][push]" 
                                                       class="form-check-input"
                                                       {% if settings.notifications and settings.notifications.building and settings.notifications.building.push %}checked{% endif %}>
                                            </div>
                                        </td>
                                        <td class="text-center">
                                            <div class="form-check">
                                                <input type="checkbox" name="notifications[building][sms]" 
                                                       class="form-check-input"
                                                       {% if settings.notifications and settings.notifications.building and settings.notifications.building.sms %}checked{% endif %}>
                                            </div>
                                        </td>
                                        <td class="text-center">
                                            <div class="form-check">
                                                <input type="checkbox" name="notifications[building][app]" 
                                                       class="form-check-input"
                                                       {% if settings.notifications and settings.notifications.building and settings.notifications.building.app %}checked{% endif %}>
                                            </div>
                                        </td>
                                    </tr>

                                    <!-- Meeting Invitations -->
                                    <tr>
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <i class="fas fa-users text-success me-2"></i>
                                                <div>
                                                    <strong>Meeting Invitations</strong>
                                                    <br><small class="text-muted">Board meetings and voting sessions</small>
                                                </div>
                                            </div>
                                        </td>
                                        <td class="text-center">
                                            <div class="form-check">
                                                <input type="checkbox" name="notifications[meetings][email]" 
                                                       class="form-check-input"
                                                       {% if settings.notifications and settings.notifications.meetings and settings.notifications.meetings.email %}checked{% endif %}>
                                            </div>
                                        </td>
                                        <td class="text-center">
                                            <div class="form-check">
                                                <input type="checkbox" name="notifications[meetings][push]" 
                                                       class="form-check-input"
                                                       {% if settings.notifications and settings.notifications.meetings and settings.notifications.meetings.push %}checked{% endif %}>
                                            </div>
                                        </td>
                                        <td class="text-center">
                                            <div class="form-check">
                                                <input type="checkbox" name="notifications[meetings][sms]" 
                                                       class="form-check-input"
                                                       {% if settings.notifications and settings.notifications.meetings and settings.notifications.meetings.sms %}checked{% endif %}>
                                            </div>
                                        </td>
                                        <td class="text-center">
                                            <div class="form-check">
                                                <input type="checkbox" name="notifications[meetings][app]" 
                                                       class="form-check-input"
                                                       {% if settings.notifications and settings.notifications.meetings and settings.notifications.meetings.app %}checked{% endif %}>
                                            </div>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <div class="mt-3">
                            <div class="form-check">
                                <input type="checkbox" id="digest_mode" name="digest_mode" class="form-check-input"
                                       {% if settings.digest_mode %}checked{% endif %}>
                                <label for="digest_mode" class="form-check-label">
                                    <strong>Digest Mode</strong> - Receive daily summary instead of individual notifications
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Quiet Hours -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5><i class="fas fa-moon me-2"></i>Quiet Hours</h5>
                    </div>
                    <div class="card-body">
                        <div class="form-check form-switch mb-3">
                            <input type="checkbox" id="enable_quiet_hours" name="enable_quiet_hours" 
                                   class="form-check-input" {% if settings.quiet_hours.enabled %}checked{% endif %}>
                            <label for="enable_quiet_hours" class="form-check-label">
                                Enable quiet hours (no push notifications or SMS during these times)
                            </label>
                        </div>

                        <div id="quiet_hours_settings" style="display: {% if settings.quiet_hours.enabled %}block{% else %}none{% endif %};">
                            <div class="row">
                                <div class="col-md-6">
                                    <label for="quiet_start" class="form-label">Start Time</label>
                                    <input type="time" id="quiet_start" name="quiet_start" class="form-control"
                                           value="{{ settings.quiet_hours.start_time or '22:00' }}">
                                </div>
                                <div class="col-md-6">
                                    <label for="quiet_end" class="form-label">End Time</label>
                                    <input type="time" id="quiet_end" name="quiet_end" class="form-control"
                                           value="{{ settings.quiet_hours.end_time or '08:00' }}">
                                </div>
                            </div>
                            <div class="form-text">Notifications will be queued and delivered after quiet hours end</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sidebar Settings -->
            <div class="col-lg-4">
                <!-- Contact Information -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5><i class="fas fa-address-book me-2"></i>Contact Information</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="email" class="form-label">Email Address</label>
                            <input type="email" id="email" name="email" class="form-control" 
                                   value="{{ current_user.email }}" readonly>
                            <div class="form-text">To change email, go to profile settings</div>
                        </div>

                        <div class="mb-3">
                            <label for="phone" class="form-label">Phone Number</label>
                            <input type="tel" id="phone" name="phone" class="form-control" 
                                   value="{{ current_user.phone or '' }}" 
                                   placeholder="+359 xxx xxx xxx">
                            <div class="form-text">Required for SMS notifications</div>
                        </div>
                    </div>
                </div>

                <!-- Push Notifications -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5><i class="fas fa-mobile-alt me-2"></i>Push Notifications</h5>
                    </div>
                    <div class="card-body">
                        <div id="push_status">
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i>
                                Push notifications are not enabled for this browser.
                            </div>
                        </div>
                        
                        <div class="d-grid">
                            <button type="button" id="enable_push" class="btn btn-primary">
                                <i class="fas fa-bell me-2"></i>Enable Push Notifications
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Buildings Filter -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5><i class="fas fa-filter me-2"></i>Building Filters</h5>
                    </div>
                    <div class="card-body">
                        <div class="form-text mb-2">Choose which buildings you want to receive notifications for:</div>
                        {% for building in user_buildings %}
                        <div class="form-check">
                            <input type="checkbox" name="building_filters" value="{{ building.id }}" 
                                   id="building_{{ building.id }}" class="form-check-input"
                                   {% if building.id in (settings.building_filters or []) %}checked{% endif %}>
                            <label for="building_{{ building.id }}" class="form-check-label">
                                {{ building.name }}
                            </label>
                        </div>
                        {% endfor %}
                        <div class="form-text mt-2">Unchecked buildings will not send notifications</div>
                    </div>
                </div>

                <!-- Advanced Settings -->
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-sliders-h me-2"></i>Advanced</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label for="notification_frequency" class="form-label">Notification Frequency</label>
                            <select id="notification_frequency" name="notification_frequency" class="form-select">
                                <option value="instant" {% if settings.frequency == 'instant' %}selected{% endif %}>Instant</option>
                                <option value="hourly" {% if settings.frequency == 'hourly' %}selected{% endif %}>Hourly</option>
                                <option value="daily" {% if settings.frequency == 'daily' %}selected{% endif %}>Daily Summary</option>
                                <option value="weekly" {% if settings.frequency == 'weekly' %}selected{% endif %}>Weekly Summary</option>
                            </select>
                        </div>

                        <div class="form-check">
                            <input type="checkbox" id="auto_read" name="auto_read" class="form-check-input"
                                   {% if settings.auto_read %}checked{% endif %}>
                            <label for="auto_read" class="form-check-label">
                                Auto-mark as read after viewing
                            </label>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Save Button -->
        <div class="card mt-4">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-save me-2"></i>Save Settings
                        </button>
                        <button type="button" class="btn btn-outline-secondary" onclick="resetToDefaults()">
                            <i class="fas fa-undo me-2"></i>Reset to Defaults
                        </button>
                    </div>
                    <div>
                        <button type="button" class="btn btn-outline-info" onclick="exportSettings()">
                            <i class="fas fa-download me-2"></i>Export Settings
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize push notification status
    checkPushNotificationStatus();
    
    // Quiet hours toggle
    document.getElementById('enable_quiet_hours').addEventListener('change', function() {
        const settings = document.getElementById('quiet_hours_settings');
        settings.style.display = this.checked ? 'block' : 'none';
    });
});

function checkPushNotificationStatus() {
    const statusDiv = document.getElementById('push_status');
    const enableButton = document.getElementById('enable_push');
    
    if ('Notification' in window && 'serviceWorker' in navigator) {
        if (Notification.permission === 'granted') {
            statusDiv.innerHTML = `
                <div class="alert alert-success">
                    <i class="fas fa-check-circle me-2"></i>
                    Push notifications are enabled and working.
                </div>
            `;
            enableButton.textContent = 'Push Notifications Enabled';
            enableButton.disabled = true;
            enableButton.className = 'btn btn-success';
        } else if (Notification.permission === 'denied') {
            statusDiv.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-times-circle me-2"></i>
                    Push notifications are blocked. Please enable in browser settings.
                </div>
            `;
            enableButton.style.display = 'none';
        } else {
            statusDiv.innerHTML = `
                <div class="alert alert-warning">
                    <i class="fas fa-bell-slash me-2"></i>
                    Push notifications are not enabled. Click below to enable.
                </div>
            `;
        }
    } else {
        statusDiv.innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle me-2"></i>
                Your browser does not support push notifications.
            </div>
        `;
        enableButton.style.display = 'none';
    }
}

document.getElementById('enable_push').addEventListener('click', function() {
    if ('Notification' in window) {
        Notification.requestPermission().then(permission => {
            if (permission === 'granted') {
                // Register service worker and subscribe to push notifications
                registerPushSubscription();
            }
            checkPushNotificationStatus();
        });
    }
});

function registerPushSubscription() {
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.ready.then(registration => {
            // Subscribe to push notifications
            return registration.pushManager.subscribe({
                userVisibleOnly: true,
                applicationServerKey: urlBase64ToUint8Array(window.vapidPublicKey)
            });
        }).then(subscription => {
            // Send subscription to server
            return fetch('/communications/api/push-subscription', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    subscription: subscription.toJSON()
                })
            });
        }).then(response => {
            if (response.ok) {
                console.log('Push subscription registered successfully');
            }
        }).catch(error => {
            console.error('Error registering push subscription:', error);
        });
    }
}

function urlBase64ToUint8Array(base64String) {
    const padding = '='.repeat((4 - base64String.length % 4) % 4);
    const base64 = (base64String + padding)
        .replace(/\-/g, '+')
        .replace(/_/g, '/');
    
    const rawData = window.atob(base64);
    const outputArray = new Uint8Array(rawData.length);
    
    for (let i = 0; i < rawData.length; ++i) {
        outputArray[i] = rawData.charCodeAt(i);
    }
    return outputArray;
}

function testNotifications() {
    fetch('/communications/api/test-notification', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Test notifications sent! Check your email, push notifications, and SMS.');
        } else {
            alert('Error sending test notifications: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error sending test notifications');
    });
}

function resetToDefaults() {
    if (confirm('Reset all notification settings to defaults?')) {
        // Reset form to default values
        document.getElementById('settingsForm').reset();
        
        // Check default notification types
        const defaultChecks = [
            'notifications[announcements][app]',
            'notifications[urgent][email]',
            'notifications[urgent][push]',
            'notifications[urgent][app]',
            'notifications[payments][email]',
            'notifications[payments][app]'
        ];
        
        defaultChecks.forEach(name => {
            const checkbox = document.querySelector(`input[name="${name}"]`);
            if (checkbox) checkbox.checked = true;
        });
        
        // Set default frequency
        document.getElementById('notification_frequency').value = 'instant';
    }
}

function exportSettings() {
    const settings = {
        notifications: {},
        quiet_hours: {
            enabled: document.getElementById('enable_quiet_hours').checked,
            start_time: document.getElementById('quiet_start').value,
            end_time: document.getElementById('quiet_end').value
        },
        frequency: document.getElementById('notification_frequency').value,
        auto_read: document.getElementById('auto_read').checked,
        building_filters: Array.from(document.querySelectorAll('input[name="building_filters"]:checked')).map(cb => cb.value)
    };
    
    // Collect notification preferences
    ['announcements', 'urgent', 'payments', 'building', 'meetings'].forEach(type => {
        settings.notifications[type] = {
            email: document.querySelector(`input[name="notifications[${type}][email]"]`)?.checked || false,
            push: document.querySelector(`input[name="notifications[${type}][push]"]`)?.checked || false,
            sms: document.querySelector(`input[name="notifications[${type}][sms]"]`)?.checked || false,
            app: document.querySelector(`input[name="notifications[${type}][app]"]`)?.checked || false
        };
    });
    
    const dataStr = JSON.stringify(settings, null, 2);
    const dataBlob = new Blob([dataStr], {type: 'application/json'});
    
    const link = document.createElement('a');
    link.href = URL.createObjectURL(dataBlob);
    link.download = 'notification-settings.json';
    link.click();
}

// Form validation
document.getElementById('settingsForm').addEventListener('submit', function(e) {
    // Validate phone number if SMS notifications are enabled
    const smsCheckboxes = document.querySelectorAll('input[name*="[sms]"]:checked');
    const phoneInput = document.getElementById('phone');
    
    if (smsCheckboxes.length > 0 && !phoneInput.value.trim()) {
        e.preventDefault();
        alert('Phone number is required for SMS notifications');
        phoneInput.focus();
        return false;
    }
    
    return true;
});
</script>
{% endblock %}